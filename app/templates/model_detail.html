{% extends "base.html" %}

{% block title %}Model · Orchestrator{% endblock %}

{% block content %}
<section class="card">
  {% if is_new %}
    <h2>Neues Model</h2>
  {% else %}
    <h2>Model: {{ model.id }}</h2>
  {% endif %}

  {% if error %}
    <p class="warning">{{ error }}</p>
  {% endif %}
  {% if notice %}
    <p class="hint">{{ notice }}</p>
  {% endif %}

  <form method="post" action="{% if is_new %}/ui/models{% else %}/ui/models/{{ model.id }}{% endif %}" class="stack">
    <label>
      Model ID
      {% if is_new %}
        <input type="text" name="model_id" value="{{ model.id }}" required />
      {% else %}
        <input type="text" name="model_id" value="{{ model.id }}" readonly />
      {% endif %}
    </label>
    <label>
      Role
      <select name="role" required>
        <option value="" {% if not model.role %}selected{% endif %}>Bitte wählen</option>
        {% for role in roles %}
          <option value="{{ role }}" {% if model.role == role %}selected{% endif %}>{{ role }}</option>
        {% endfor %}
      </select>
    </label>
    {% if model.role %}
      {% set suggestions = models_by_role.get(model.role) or [] %}
      {% if suggestions %}
        <p class="hint">Vorhandene Modelle für {{ model.role }}: {{ suggestions | join(", ") }}</p>
      {% endif %}
    {% endif %}
    <p class="hint">Weights werden nicht geladen. Diese App verbindet sich mit einem Runtime-Server.</p>
    <p class="hint">Provider bestimmt Runtime/Discovery/Auto-Start Verhalten.</p>
    <input type="hidden" name="provider" id="provider" value="{{ model.provider or "" }}" />
    <div class="tabs" data-tabs="provider">
      <div class="tab-buttons">
        <button type="button" class="tab-button" data-provider="ollama">Ollama</button>
        <button type="button" class="tab-button" data-provider="llamacpp">llama.cpp</button>
        <button type="button" class="tab-button" data-provider="openai">OpenAI-compat/vLLM</button>
      </div>
      <div class="tab-panels">
        <section class="tab-panel" data-provider="ollama">
          <label>
            Model Name
            <input type="text" name="model_name" value="{{ model.model_name or "" }}" list="ollama-models" required />
          </label>
          <label>
            Base URL
            <input type="text" name="base_url" value="{{ model.base_url or ollama_base_url }}" placeholder="http://localhost:11434" required />
          </label>
          <div class="stack">
            <button
              type="button"
              class="button"
              hx-get="/ui/models/discover/ollama_models"
              hx-include=".tab-panel.is-active [name='base_url']"
              hx-target="#ollama-models-container"
              hx-swap="innerHTML"
            >
              Modelle abrufen (Ollama API)
            </button>
            <button
              type="button"
              class="button"
              hx-get="/ui/models/discover/ollama_test"
              hx-include=".tab-panel.is-active [name='base_url']"
              hx-target="#ollama-connection-status"
              hx-swap="innerHTML"
            >
              Test connection
            </button>
            <div id="ollama-connection-status"></div>
            <div id="ollama-models-container">
              <datalist id="ollama-models"></datalist>
            </div>
          </div>
        </section>
        <section class="tab-panel" data-provider="llamacpp">
          <label>
            Model Name
            <input type="text" name="model_name" value="{{ model.model_name or "" }}" required />
          </label>
          <label>
            Base URL
            <input type="text" name="base_url" value="{{ model.base_url or "" }}" placeholder="http://127.0.0.1:8001" required />
          </label>
          <label>
            Model Path (local GGUF)
            <input
              type="text"
              name="model_path"
              value="{{ model.model_path or "" }}"
              list="local-gguf-models"
            />
          </label>
          <label>
            Context Size (optional)
            <input type="number" name="ctx_size" min="0" />
          </label>
          <label>
            Threads (optional)
            <input type="number" name="threads" min="0" />
          </label>
          <div class="stack">
            <button
              type="button"
              class="button"
              hx-get="/ui/models/discover/local_gguf"
              hx-target="#local-gguf-models-container"
              hx-swap="innerHTML"
            >
              Lokale GGUFs vorschlagen
            </button>
            <div id="local-gguf-models-container">
              <datalist id="local-gguf-models"></datalist>
            </div>
          </div>
          <label>
            llama-server Binary (optional)
            <input type="text" name="llamacpp_binary_path" placeholder="/usr/local/bin/llama-server" />
          </label>
          <div class="stack">
            <button type="button" class="button" id="llamacpp-start">
              Start llama-server
            </button>
            <button type="button" class="button" id="llamacpp-stop">
              Stop llama-server
            </button>
            <button type="button" class="button" id="llamacpp-use-endpoint">
              Use running endpoint as base_url
            </button>
            <input type="hidden" name="runtime_instance_id" id="llamacpp-instance-id" />
            <div id="llamacpp-runtime-status" class="hint"></div>
            <div id="llamacpp-health-status" class="hint"></div>
            <div id="llamacpp-running-list" class="hint"></div>
          </div>
        </section>
        <section class="tab-panel" data-provider="openai">
          <label>
            Provider Type
            <select id="openai-provider-select">
              <option value="openai-compatible" {% if model.provider == "openai-compatible" %}selected{% endif %}>OpenAI-compatible</option>
              <option value="vllm" {% if model.provider == "vllm" %}selected{% endif %}>vLLM</option>
            </select>
          </label>
          <label>
            Model Name
            <input type="text" name="model_name" value="{{ model.model_name or "" }}" list="openai-models" required />
          </label>
          <label>
            Base URL
            <input type="text" name="base_url" value="{{ model.base_url or "" }}" placeholder="https://host:port/v1" required />
          </label>
          <div class="stack">
            <button
              type="button"
              class="button"
              hx-get="/ui/models/discover/openai_models"
              hx-include=".tab-panel.is-active [name='base_url']"
              hx-target="#openai-models-container"
              hx-swap="innerHTML"
            >
              Modelle abrufen (OpenAI-compat)
            </button>
            <button
              type="button"
              class="button"
              hx-get="/ui/models/discover/openai_test"
              hx-include=".tab-panel.is-active [name='base_url']"
              hx-target="#openai-connection-status"
              hx-swap="innerHTML"
            >
              Test connection
            </button>
            <div id="openai-connection-status"></div>
            <div id="openai-models-container">
              <datalist id="openai-models"></datalist>
            </div>
          </div>
        </section>
      </div>
    </div>
    <label>
      Prompt Profile
      <textarea name="prompt_profile" rows="6" required>{{ model.prompt_profile or "" }}</textarea>
    </label>
    <label>
      Adapter (optional metadata)
      <textarea name="adapter" rows="3" placeholder='{"notes": "..."}'>{{ model.adapter or "" }}</textarea>
    </label>

    {% if model.role == "validator" %}
      {% set config = model.validator_config or {} %}
      <fieldset class="stack">
        <legend>Validator Config</legend>
        <label>
          <input type="checkbox" name="validator_use_llm" {% if config.use_llm %}checked{% endif %} />
          Use LLM runtime
        </label>
        <label>
          Max Attempts
          <input type="number" name="validator_max_attempts" min="0" value="{{ config.max_attempts or "" }}" />
        </label>
        <label>
          Compression Token Budget
          <input type="number" name="validator_compression_token_budget" min="0" value="{{ config.compression_token_budget or "" }}" />
        </label>
        <label>
          Stop Conditions (one per line)
          <textarea name="validator_stop_conditions" rows="3">{{ config.stop_conditions | join('\n') if config.stop_conditions else "" }}</textarea>
        </label>
        <label>
          Allowed Decisions (one per line)
          <textarea name="validator_allowed_decisions" rows="4">{{ config.allowed_decisions | join('\n') if config.allowed_decisions else "" }}</textarea>
        </label>
        <label>
          Allowed Retry Strategies (one per line)
          <textarea name="validator_allowed_retry_strategies" rows="4">{{ config.allowed_retry_strategies | join('\n') if config.allowed_retry_strategies else "" }}</textarea>
        </label>
        <label>
          Rubric Weights (JSON)
          <textarea name="validator_rubric_weights" rows="3" placeholder='{"correctness": 0.4}'>{{ config.rubric_weights | tojson if config.rubric_weights else "" }}</textarea>
        </label>
      </fieldset>
    {% endif %}

    <div class="actions">
      <button type="submit" class="primary">Speichern</button>
      <a class="button" href="/ui/models">Zurück</a>
    </div>
  </form>

  {% if not is_new %}
  <form method="post" action="/ui/models/{{ model.id }}/test" class="actions">
    <button type="submit" class="button">Dry-Run Test</button>
  </form>
  {% endif %}
</section>
<script src="/static/models_tabs.js" defer></script>
<script src="/static/model_detail.js" defer></script>
{% endblock %}
